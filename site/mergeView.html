<!doctype html>
<head>
<title>CodeMirror: merge view demo</title>
<meta charset="utf-8"/>

  <!--symbols-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous" />
  
<!-- CSS only -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<!-- JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
 

<link rel=stylesheet href="https://codemirror.net/lib/codemirror.css">
<link rel=stylesheet href="https://codemirror.net/addon/merge/merge.css">
<script src="https://codemirror.net/lib/codemirror.js"></script>
<script src="https://codemirror.net/mode/xml/xml.js"></script>
<script src="https://codemirror.net/mode/css/css.js"></script>
<script src="https://codemirror.net/mode/javascript/javascript.js"></script>
<script src="https://codemirror.net/mode/htmlmixed/htmlmixed.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
<script src="https://codemirror.net/addon/merge/merge.js"></script>





<style>
  html, body{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
  }
  
    .CodeMirror { line-height: 1.2; }
    @media screen and (min-width: 1300px) {
      article { max-width: 1000px; }
      #nav { border-right: 499px solid transparent; }
    }
    span.clicky {
      cursor: pointer;
      background: #d70;
      color: white;
      padding: 0 3px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container-fluid h-100">
    <div class="float-right w-100">
      <div class="">
        <h2>MergeView</h2>
        <span class=clicky onclick="toggleDifferences()"><i class="fas fa-highlighter"></i>Show Diffs</span>

        In the two-way configuration, there are also options to pad changed
        sections to <span class=clicky onclick="currentOpts.connect = currentOpts.connect ? null :
        'align'; setOpts()">align</span> them, and to <span class=clicky
        onclick="currentOpts.collapseIdentical = !currentOpts.collapseIdentical; setOpts(currentOpts)">collapse</span> unchanged
        stretches of text.</p>

        <p>This addon depends on
        the <a href="https://code.google.com/p/google-diff-match-patch/">google-diff-match-patch</a>
        library to compute the diffs.</p>
      </div>
    </div>
    <div class="h-100 w-100" style="padding-top:10em;">
      <div id="view" class=""></div>
    </div> <!--row-->
  </div> <!--container-->
<script>
  /*
  Dev notes:
  Due dilligance: ace is slow. It is just slow. Braket.io is using codemirror 
   - also this merge tool doesn't have scroll lock https://github.com/ace-diff/ace-diff/tree/master
   - mergely is incomplete, doesn't have scroll lock and is buggy at best. It also uses codemirror so thats cool. but not having scroll lock kills it as an option
  Manual for codemirror:https://codemirror.net/doc/manual.html
  Orignal demo https://codemirror.net/demo/merge.html
  //TODO Change theme demo https://codemirror.net/demo/theme.html#solarized%20light
  //TODO use google highlighters https://github.com/codemirror/google-modes
  //TODO add more mime types/modes  https://codemirror.net/mode/
  //TODO same as above https://codemirror.net/mode/clike/index.html (this shows some at the bototm)
  //TODO fix height code (I am using the origingal with demo but check this gist for possible fix https://gist.github.com/marijnh/9683027
  */

    var dv;
  var currentOpts={panes:2,highlightDifferences:true,connect:'align',collapseIdentical:false}

  function setOpts(opts){
    if(!opts){
      opts=currentOpts
    }
    opts=$.extend(currentOpts,opts)
    initUI(opts)
  }
  function initUI(opts) {
    if (opts.file0 == null) return;
    var target = document.getElementById("view");
    target.innerHTML = "";
    //https://codemirror.net/doc/manual.html#addon_merge"
    dv = CodeMirror.MergeView(target, {
      value: opts.file0,
      origLeft: opts.panes == 3 ? opts.file1 : null,
      orig: opts.file2,
      lineNumbers: true,
      mode: "text/html",
      highlightDifferences: opts.highlightDifferences,
      connect: opts.connect,
      allowEditingOriginals:true,
      collapseIdentical: opts.collapseIdentical
    });
    
    var codeMirrorDoc=document.querySelectorAll('.CodeMirror-merge')[0]
    var codeViews=codeMirrorDoc.querySelectorAll('.CodeMirror-merge-pane')
    Array.prototype.slice.call(codeViews).forEach(function(item,index){
      var corner=item.querySelectorAll('.CodeMirror-scrollbar-filler')[0]
      if(index==0){
        var a=$('<a/>').attr('href','#').html('<i class="far fa-window-maximize"></i>').click(function(e){
            e.preventDefault()
            currentOpts.panes = 3; setOpts();
            return false;
          })
          $(corner).append(a);
      }else if(index==1){
        if(codeViews.length<=2){
          var a=$('<a/>').attr('href','#').html('<i class="fas fa-plus-circle"></i>').click(function(e){
            e.preventDefault()
            currentOpts.panes = 3; setOpts();
            return false;
          })
          $(corner).append(a);
        }
      }else if (index==2){
          var a=$('<a/>').attr('href','#').html('<i class="fas fa-minus-circle"></i>').click(function(e){
            e.preventDefault()
            currentOpts.panes = 2; setOpts();
            return false;
          })
          $(corner).append(a);
      }
    });

  }

  function toggleDifferences() {
    dv.setShowDifferences(currentOpts.highlightDifferences = !currentOpts.highlightDifferences);
  }

  window.onload = function() {
    currentOpts.file0 = document.documentElement.innerHTML;
    currentOpts.file1 = "<!doctype html>\n\n" + currentOpts.file0.replace(/\.\.\//g, "codemirror/").replace("yellow", "orange");
    currentOpts.file2 = currentOpts.file0.replace(/\u003cscript/g, "\u003cscript type=text/javascript ")
      .replace("white", "purple;\n      font: comic sans;\n      text-decoration: underline;\n      height: 15em");
    initUI(currentOpts);
    //let d = document.createElement("div"); d.style.cssText = "width: 50px; margin: 7px; height: 14px"; dv.editor().addLineWidget(57, d)

  };

  function mergeViewHeight(mergeView) {
    function editorHeight(editor) {
      if (!editor) return 0;
      return editor.getScrollInfo().height;
    }
    return Math.max(editorHeight(mergeView.leftOriginal()),
                    editorHeight(mergeView.editor()),
                    editorHeight(mergeView.rightOriginal()));
  }

  function resize(mergeView) {
    var height = mergeViewHeight(mergeView);
    for(;;) {
      if (mergeView.leftOriginal())
        mergeView.leftOriginal().setSize(null, height);
      mergeView.editor().setSize(null, height);
      if (mergeView.rightOriginal())
        mergeView.rightOriginal().setSize(null, height);

      var newHeight = mergeViewHeight(mergeView);
      if (newHeight >= height) break;
      else height = newHeight;
    }
    mergeView.wrap.style.height = height + "px";
  }
  //window.addEventListener("resize", function(){resize(dv);}, true);
</script>
</body>
</html>
