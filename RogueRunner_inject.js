(function(l,v,I,P,k,q,J,Q,U,D,x){function K(){return(Math.floor(9E15*Math.random())+1).toString(36)+"-"+(new Date).getTime().toString(36)}function z(){var a=Array.prototype.slice.call(arguments);a.unshift("RogueBM[injection]: ");k.error.apply(k,a)}function L(a,c,b){"string"==typeof a&&(a=v.createElement(a));for(var d=Object.keys(c),e=0,r=d.length;e<r;e++)0<=V.indexOf(d[e])?a.setAttribute(d[e],c[d[e]]):a[d[e]]=c[d[e]];b&&b.appendChild(a);return a}function M(a,c,b,d){function e(t,m){if(p)k("call after BLOCKED");else if(w)u&&k.log("call after finish!!!",d);else if(p=1,c())u&&k.log("test",c),w=!0,g.loaded(a),b&&b.call&&b(),p=0;else{!0===n&&(N=n,r=100);if(t||100<=r++){w=1;if(d)return p=0,q(function(){N&&0<=["ajax","xdomainiframe"].indexOf(d)&&(d="iframe");u&&k.log("fallback is going to ",d,a);W[d](a,c,b)},1);p=0;return b&&q(function(){b("error:inlining failed")},1)}n=null;m&&!N&&(n=!0,r=100,q(function(){c()||R(null,m)},1),q(function(){c()||(new Function(m))()},1),q(function(){c()||eval(m)},1));p=0;q(e,100)}}var r=0,w=!1,n,p=0;return e}function R(a,c,b){b=b&&b.call?b:function(e){e&&z(e)};var d=L("script",{type:"text/javascript",id:"injected_"+K()+"_"+X++});if(c)try{d.appendChild(v.createTextNode(c))}catch(e){d.text=c,q(function(){b(null,c)},1)}else L(d,{src:a,f:"anonymous"}),d.onerror=d.onload=b,q(b,1);v.getElementsByTagName("head")[0].appendChild(d);return d}function Y(a,c){var b=l.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.onreadystatechange=function(){4==b.readyState&&(200==b.status||0==b.status?c(null,b.responseText):c(b.status))};try{b.open("GET",a,!0),b.send()}catch(d){c(d)}}function S(){function a(c,b,d){function e(f){u&&k.log("got message",f);if(d.includes(f.origin)){var h=null;try{h=J.parse(f.data)}catch(ba){h=f.data;"RogueRunner:Blur"==h&&(m.display="none");return}var y=h.error;h.error=null;delete h.error;if(y)z(y,h,f);else if(h.ready)u&&k.log("doing preload handlers"),r();else if(null==h.messageID)k.error("need data.messageID for callbacks to function",f);else{var A=E[h.messageID];A?A.method!=A.method?z("methods do not match. Possible security risk"):(A.a&&A.a(y,h,f),E[h.messageID]=null,delete E[h.messageID]):z("no handler found for ",f.messageID,f)}}else k.warn("rejected post message from",f.origin,"Allowed origins are",d,"you attempted",f)}function r(){clearTimeout(0);w.status="ready";if(p){for(var f=0;f<p.length;f++)n[B](J.stringify(p[f]),"*");p=null}}var w=this,n,p=[];w.status="loading";var t,m,T;l.b(function(){if(!D.forcePopOut){t=L("iframe",{onerror:function(){w.status="blocked"},frameBorder:"0",allowTransparency:"true",src:b,style:"background-color:transparent;display:none;position:absolute"},v.body);t.addEventListener("load",r);m=t.style;try{n=t.contentWindow}catch(f){n=t.contentWindow}}if(!t||!t.contentDocument||!n){t=null;n=T=l.open(b.src||b,"RogueRunner","scrollbars=no, width=1, height=1, top=1, left=1");if(!n||n.closed||"undefined"==typeof n.closed)w.status="blocked";n.blur()}});var E={};c.addEventListener?c.addEventListener("message",e,!1):c.attachEvent("onmessage",e);this.getScript=function(f,h){this[B]({method:"getScript",url:f},h)};this[B]=function(f,h){E[f.messageID=K()]={a:h,method:f.method};if(null!=p)p.push(f);else n[B](J.stringify(f),"*")};this.convertToInterface=function(){this[B]({method:"convertToInterface"},function(f,h){h.data&&(t&&(m.width=m.height="100%",m.display="block",m.position="absolute",m.bottom=m.right="0",m.border="0",g.show=function(){m.display="block"},v.addEventListener("keyup",function(y){y.ctrlKey&&192==y.keyCode&&g.show()},!1)),T&&Q("not implemented yet"))})}}l.b=function(){var c=[],b,d=(v.documentElement.doScroll?/^loaded|^c/:/^loaded|^i|^c/).test(v.readyState);return!d&&v.addEventListener("DOMContentLoaded",b=function(){v.removeEventListener("DOMContentLoaded",b);for(d=1;b=c.shift();)b()}),function(e){d?q(e,0):c.push(e)}}();g.CrossOriginLocalStorage=a;g.xDLStorage=new a(l,"https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html#localstorage",["https://ktsuttlemyre.github.io"])}function F(a,c,b){if(c!=C)return k.error("RogueRunner[injector]: sessionID either not correct or not provided. Will not load this url",a),1;c=M(a,b,function(){u&&k.log("####complete#####")},"ajax");R(a,!1,c);q(c,1);return 0}var u=D.debug,B="postMessage",g=l.RogueBM=l.RogueBM||{};x==String.fromCharCode(37,115)&&(x="");var V=["style"],W={h:function(a,c,b,d){u&&k.info("using popup last resort");a=1;c=l.screenLeft||l.screenX||0;b=l.innerWidth||I.clientWidth||screen.width||0;null==a&&(a=b/l.screen.availWidth||1);a=l.open("https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html","RogueRunner","scrollbars=no, width="+500/a+", height="+200/a+", top=0, left="+((b-500)/2/a+c));a.focus&&a.focus();a&&!a.closed&&"undefined"!=typeof a.closed||Q("RogueRunner external window popup blocked");d&&d.call&&d()},g:function(a){u&&k.info("using iframe to show");a===G&&(u&&k.log("using iframe embed for RogueRunner only",l===parent,G),g.xDLStorage.convertToInterface())},c:function(a,c,b){u&&k.info("using ajax to inline");c=M(a,c,b,"xdomainiframe");Y(a,c);q(c,1)},i:function(a,c,b){u&&k.info("using xDiframe to inline");var d=M(a,c,b,"iframe");g.xDLStorage.getScript(a,function(e,r){e?z("Error loading script from xDiframe",e):d(e,r&&r.data)});q(d,1)}},N,X=0;g.lastCMD=x;if(g.show)g.CrossOriginLocalStorage||S(),x||g.show();else{var H=D.skin;H=("all"in I.style||"cssall"in I.style)&&0!=H?"_"+H:"";var G="https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner_src"+H+".js?user="+P(D.user);x&&(G+="&cmd="+P(x));var O=["RogueRunner.js","index.js","js-yaml.min.js"],Z=[];g.loaded=function(a){k.log("loaded",a);a=a.split("/").pop();Z.push(a);O=O.filter(function(c){return c!=a});!O.length&&g.init()};var C=K();S();F("https://ktsuttlemyre.github.io/RogueBookmarklets/libs/js-yaml.min.js",C,function(){return l.jsyaml});F("https://ktsuttlemyre.github.io/RogueBookmarklets/index.js",C,function(){return g.scripts});F(G,C,function(){return g.show});g.injectScript=F;g.getSessionID=function(){prompt("Copy the session id below to use in protected RogueBM[injector] calls",C)};g.about={injector:{revision:"{{ site.github.build_revision }}",version:U}};var aa="toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=800,height=300,top="+(screen.height-800)+",left="+(screen.width-300);g.open=function(a){l.open(a,"_blank",aa)}}})(this,document,document.documentElement,encodeURIComponent,console,setTimeout,JSON,alert,"0.0.5",{user:"anonymous",skin:"experimental",debug:!1},"%s");
