(function(e,m,p,k,N,A,w){function F(){return Math.floor(9E10*Math.random())+9E10+"-"+Date.now()}function x(){var a=Array.prototype.slice.call(arguments);a.length&&(a.unshift("RogueBM[injection]: "),p.error.apply(p,a))}function G(a,c,b){"string"==typeof a&&(a=m.createElement(a));for(var d=Object.keys(c),f=0,q=d.length;f<q;f++)0<=O.indexOf(d[f])?a.setAttribute(d[f],c[d[f]]):a[d[f]]=c[d[f]];b&&b.appendChild(a);return a}function B(a,c,b,d){function f(l,n){if(!v)if(c())v=!0,e.RogueBM.loaded(a),b&&b.call&&b();else{if(l||100<=q++)return d?k(function(){P[d](a,c,b)},1):b&&k(function(){b("error:inlining failed")},1);n&&(q=100,k(function(){c()||J(null,n)},1),k(function(){c()||(new Function(n))()},1),k(function(){c()||eval(n)},1));k(f,100)}}var q=0,v=!1;return f}function J(a,c,b){b=b&&b.call?b:function(f){x(f)};var d=G("script",{type:"text/javascript",id:"injected_"+F()+"_"+Q++});if(c)try{d.appendChild(m.createTextNode(c))}catch(f){d.text=c,k(function(){b(null,c)},1)}else G(d,{src:a,f:"anonymous"}),d.onerror=d.onload=b,k(b,1);m.getElementsByTagName("head")[0].appendChild(d);return d}function R(a,c){var b=e.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.onreadystatechange=function(){4==b.readyState&&(200==b.status||0==b.status?c(null,b.responseText):c(b.status))};try{b.open("GET",a,!0),b.send()}catch(d){c(d)}}function K(){function a(c,b,d){function f(g){p.log("got message",g);if(d.includes(g.origin)){var h=null;try{h=JSON.parse(g.data)}catch(U){return}var r=h.error;h.error=null;delete h.error;r&&x(r,h,g);if(h.ready)p.log("doing preload handlers"),q();else if(null==h.messageID)p.error("need data.messageID for callbacks to function",g);else{var y=C[h.messageID];y?y.method!=y.method?x("methods do not match. Possible security risk"):(y.a&&y.a(r,h,g),C[h.messageID]=null,delete C[h.messageID]):x("no handler found for ",g.messageID,g)}}else p.warn("rejected post message from",g.origin,"Allowed origins are",d,"you attempted",g)}function q(){clearTimeout(0);v.status="ready";if(n){for(var g=0;g<n.length;g++)l.postMessage(JSON.stringify(n[g]),"*");n=null}}var v=this,l,n=[];v.status="loading";var t,L;e.b(function(){if(!A.forcePopOut){t=G("iframe",{onerror:function(){v.status="blocked"},frameBorder:0,allowTransparency:"true",src:b,style:"background-color:transparent;display:none;position:absolute"},m.body);t.addEventListener("load",q);try{l=t.contentWindow}catch(g){l=t.contentWindow}}if(!t||!t.contentDocument||!l){t=null;l=L=e.open(b.src||b,"RogueRunner","scrollbars=no, width=1, height=1, top=1, left=1");if(!l||l.closed||"undefined"==typeof l.closed)v.status="blocked";l.blur()}});var C={};c.addEventListener?c.addEventListener("message",f,!1):c.attachEvent("onmessage",f);this.getScript=function(g,h){this.postMessage({method:"getScript",url:g},h)};this.postMessage=function(g,h){var r=F();g.messageID=r;C[r]={a:h,method:g.method};null!=n?n.push(g):l.postMessage(JSON.stringify(g),"*")};this.convertToInterface=function(){this.postMessage({method:"convertToInterface"},function(g,h){h.data&&(t&&(e.RogueBM.show=function(){},m.addEventListener("keyup",function(r){r.ctrlKey&&192==r.keyCode&&e.RogueBM.show()},!1)),L&&alert("not implemented yet"))})}}e.b=function(){var c=[],b,d=(m.documentElement.doScroll?/^loaded|^c/:/^loaded|^i|^c/).test(m.readyState);return!d&&m.addEventListener("DOMContentLoaded",b=function(){m.removeEventListener("DOMContentLoaded",b);for(d=1;b=c.shift();)b()}),function(f){d?k(f,0):c.push(f)}}();e.RogueBM.CrossOriginLocalStorage=a;e.RogueBM.xDLStorage=new a(e,"https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html#localstorage",["https://ktsuttlemyre.github.io"])}function D(a,c,b){if(c!=z)return p.error("RogueRunner[injector]: sessionID either not correct or not provided. Will not load this url",a),1;var d=B(a,b,function(){p.log("####complete#####")},"localstorage");A.forceIframeInject?k(function(){d("forced error")},1):J(a,!1,d);return 0}Date.now||(Date.now=function(){return(new Date).getTime()});w==String.fromCharCode(37,115)&&(w="");var O=["style"],P={i:function(a,c,b,d){a=1;c=e.screenLeft||e.screenX||0;b=e.innerWidth||m.documentElement.clientWidth||screen.width||0;null==a&&(a=b/e.screen.availWidth||1);a=e.open("https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html","RogueRunner","scrollbars=no, width="+500/a+", height="+200/a+", top=0, left="+((b-500)/2/a+c));a.focus&&a.focus();a&&!a.closed&&"undefined"!=typeof a.closed||alert("RogueRunner external window popup blocked");d&&d.call&&d()},g:function(a,c,b){a===H&&(p.log("using iframe embed for RogueRunner only"),a=B(a,c,b,"popup"),xDLStorage.convertToInterface(a),k(a,1))},c:function(a,c,b){c=B(a,c,b,"iframe");R(a,c);k(c,1)},h:function(a,c,b){var d=B(a,c,b,"ajax");e.RogueBM.xDLStorage.getScript(a,function(f,q){f&&x("Error loading script from xDLStorage",f);d(f,q&&q.data)});k(d,1)}},Q=0,u=e.RogueBM=e.RogueBM||{};u.lastCMD=w;if(u.show)u.CrossOriginLocalStorage||K(),w||u.show();else{var M=m.documentElement,E=A.skin;E=("all"in M.style||"cssall"in M.style)&&0!=!!E?"_"+E:"";var H="https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner_src"+E+".js?user="+encodeURIComponent(A.user);w&&(H+="&cmd="+encodeURIComponent(w));var I=["RogueRunner.js","index.js","js-yaml.min.js"],S=[];e.RogueBM.loaded=function(a){p.log("loaded",a);a=a.split("/").pop();S.push(a);I=I.filter(function(c){return c!=a});!I.length&&e.RogueBM.init()};var z=F();K();D("https://ktsuttlemyre.github.io/RogueBookmarklets/libs/js-yaml.min.js",z,function(){return e.jsyaml});D("https://ktsuttlemyre.github.io/RogueBookmarklets/index.js",z,function(){return e.RogueBM.scripts});D(H,z,function(){return e.RogueBM.loaded});u.injectScript=D;u.getSessionID=function(){prompt("Copy the session id below to use in protected RogueBM[injector] calls",z)};u.about={injector:{revision:"{{ site.github.build_revision }}",version:N}};var T="toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=800,height=300,top="+(screen.height-800)+",left="+(screen.width-300);u.open=function(a){e.open(a,"_blank",T)}}})(this,document,console,setTimeout,"0.0.1",{user:"anonymous",skin:"experimental"},"%s");
