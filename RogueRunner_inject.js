(function(e,m,r,l,N,B,x){function G(){return Math.floor(9E10*Math.random())+9E10+"-"+Date.now()}function y(){var a=Array.prototype.slice.call(arguments);a.length&&(a.unshift("RogueBM[injection]: "),r.error.apply(r,a))}function C(a,c,b,d){function h(n,q){if(!w)if(c())w=!0,e.RogueBM.loaded(a),b&&b.call&&b();else{if(n||100<=u++)return d?l(function(){O[d](a,c,b)},1):b&&l(function(){b("error:inlining failed")},1);q&&(u=100,l(function(){c()||J(null,q)},1),l(function(){c()||(new Function(q))()},1),l(function(){c()||eval(q)},1));l(h,100)}}var u=0,w=!1;return h}function J(a,c,b){b=b&&b.call?b:function(h){y(h)};var d=m.createElement("script");d.setAttribute("type","text/javascript");d.id="injected_"+G()+"_"+P++;if(c)try{d.appendChild(m.createTextNode(c))}catch(h){d.text=c,l(function(){b(null,c)},1)}else d.setAttribute("src",a),d.setAttribute("crossorigin","anonymous"),d.onerror=b,d.onload=b,l(b,1);m.getElementsByTagName("head")[0].appendChild(d);return d}function Q(a,c){var b=e.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.onreadystatechange=function(){4==b.readyState&&(200==b.status||0==b.status?c(null,b.responseText):c(b.status))};try{b.open("GET",a,!0),b.send()}catch(d){c(d)}}function K(){function a(c,b,d){function h(f){r.log("got message",f);if(d.includes(f.origin)){var g=null;try{g=JSON.parse(f.data)}catch(T){g=f.data;"RogueRunner:Blur"==g&&(p.display="none");return}var t=g.error;g.error=null;delete g.error;t&&y(t,g,f);if(g.ready)r.log("doing preload handlers"),u();else if(null==g.messageID)r.error("need data.messageID for callbacks to function",f);else{var z=D[g.messageID];z?z.method!=z.method?y("methods do not match. Possible security risk"):(z.a&&z.a(t,g,f),D[g.messageID]=null,delete D[g.messageID]):y("no handler found for ",f.messageID,f)}}else r.warn("rejected post message from",f.origin,"Allowed origins are",d,"you attempted",f)}function u(){clearTimeout(0);w.status="ready";if(q){for(var f=0;f<q.length;f++)n.postMessage(JSON.stringify(q[f]),"*");q=null}}var w=this,n,q=[];w.status="loading";var k,p,L;e.b(function(){if(!B.forcePopOut){k=m.createElement("iframe");k.addEventListener("load",u);k.onerror=function(){w.status="blocked"};k.style.backgroundColor="transparent";k.frameBorder="0";k.allowTransparency="true";k.src=b;p=k.style;p.display="none";p.position="absolute";m.body.appendChild(k);try{n=k.contentWindow}catch(f){n=k.contentWindow}}if(!k||!k.contentDocument||!n){k=null;n=L=e.open(b.src||b,"RogueRunner","scrollbars=no, width=1, height=1, top=1, left=1");if(!n||n.closed||"undefined"==typeof n.closed)w.status="blocked";n.blur()}});var D={};c.addEventListener?c.addEventListener("message",h,!1):c.attachEvent("onmessage",h);this.getScript=function(f,g){this.postMessage({method:"getScript",url:f},g)};this.postMessage=function(f,g){var t=G();f.messageID=t;D[t]={a:g,method:f.method};null!=q?q.push(f):n.postMessage(JSON.stringify(f),"*")};this.convertToInterface=function(){this.postMessage({method:"convertToInterface"},function(f,g){g.data&&(k&&(p.width=p.height="100%",p.display="block",p.position="absolute",p.bottom=p.right="0",p.border="0",e.RogueBM.show=function(){p.display="block"},m.addEventListener("keyup",function(t){t.ctrlKey&&192==t.keyCode&&e.RogueBM.show()},!1)),L&&alert("not implemented yet"))})}}e.b=function(){var c=[],b,d=(m.documentElement.doScroll?/^loaded|^c/:/^loaded|^i|^c/).test(m.readyState);return!d&&m.addEventListener("DOMContentLoaded",b=function(){m.removeEventListener("DOMContentLoaded",b);for(d=1;b=c.shift();)b()}),function(h){d?l(h,0):c.push(h)}}();e.RogueBM.CrossOriginLocalStorage=a;e.RogueBM.xDLStorage=new a(e,"https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html#localstorage",["https://ktsuttlemyre.github.io"])}function E(a,c,b){if(c!=A)return r.error("RogueRunner[injector]: sessionID either not correct or not provided. Will not load this url",a),1;var d=C(a,b,function(){r.log("####complete#####")},"localstorage");B.forceIframeInject?l(function(){d("forced error")},1):J(a,!1,d);return 0}Date.now||(Date.now=function(){return(new Date).getTime()});x==String.fromCharCode(37,115)&&(x="");var O={h:function(a,c,b,d){a=1;c=e.screenLeft||e.screenX||0;b=e.innerWidth||m.documentElement.clientWidth||screen.width||0;null==a&&(a=b/e.screen.availWidth||1);a=e.open("https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner.html","RogueRunner","scrollbars=no, width="+500/a+", height="+200/a+", top=0, left="+((b-500)/2/a+c));a.focus&&a.focus();a&&!a.closed&&"undefined"!=typeof a.closed||alert("RogueRunner external window popup blocked");d&&d.call&&d()},f:function(a,c,b){a===H&&(r.log("using iframe embed for RogueRunner only"),a=C(a,c,b,"popup"),xDLStorage.convertToInterface(a),l(a,1))},c:function(a,c,b){c=C(a,c,b,"iframe");Q(a,c);l(c,1)},g:function(a,c,b){var d=C(a,c,b,"ajax");e.RogueBM.xDLStorage.getScript(a,function(h,u){h&&y("Error loading script from xDLStorage",h);d(h,u&&u.data)});l(d,1)}},P=0,v=e.RogueBM=e.RogueBM||{};v.lastCMD=x;if(v.show)v.CrossOriginLocalStorage||K(),x||v.show();else{var M=m.documentElement,F=B.skin;F=("all"inM.style||"cssall"in M.style)&&0!=!!F?"_"+F:"";var H="https://ktsuttlemyre.github.io/RogueBookmarklets/RogueRunner_src"+F+".js?user="+encodeURIComponent(B.user);x&&(H+="&cmd="+encodeURIComponent(x));var I=["RogueRunner.js","index.js","js-yaml.min.js"],R=[];e.RogueBM.loaded=function(a){r.log("loaded",a);a=a.split("/").pop();R.push(a);I=I.filter(function(c){return c!=a});!I.length&&e.RogueBM.init()};var A=G();K();E("https://ktsuttlemyre.github.io/RogueBookmarklets/libs/js-yaml.min.js",A,function(){return e.jsyaml});E("https://ktsuttlemyre.github.io/RogueBookmarklets/index.js",A,function(){return e.RogueBM.scripts});E(H,A,function(){return e.RogueBM.loaded});v.injectScript=E;v.getSessionID=function(){prompt("Copy the session id below to use in protected RogueBM[injector] calls",A)};v.about={injector:{revision:"{{ site.github.build_revision }}",version:N}};var S="toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=800,height=300,top="+(screen.height-800)+",left="+(screen.width-300);v.open=function(a){e.open(a,"_blank",S)}}})(this,document,console,setTimeout,"0.0.1",{user:"anonymous",skin:"experimental"},"%s");
