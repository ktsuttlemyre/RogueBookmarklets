---
---
<head>
    <title>RogueRunner</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="theme-color" content="#222531">
		<script type="text/template" id="RogueRunner"></script>
		<script type="text/javascript" src="/RogueBookmarklets/tests/load.js"></script>
		<script type="text/javascript" src="/RogueBookmarklets/index.js"></script>
		<style>
			html, body {margin:0;padding:0;}
			.phi-layout * {margin:0;padding:0; float:left}
			.phi-layout iframe {border:0}
			.phi-layout *:only-child{
				width:100% !important;
				height:100% !important;
			}
			.phi-layout .phi-right>*:nth-child(1) {
				width:62%;
				height:100%;
			}
			.phi-layout .phi-right>*:nth-child(2) {
				width:38%;
				height:100%;
			}
			.phi-layout .phi-left>*:nth-child(1) {
				width:38%;
				height:100%;
			}
			.phi-layout .phi-left>*:nth-child(2) {
				width:62%;
				height:100%;
			}
			
			
			.phi-layout .phi-bottom>*:nth-child(1) {
				width:100%;
				height:62%;
			}
			.phi-layout .phi-bottom>*:nth-child(2) {
				width:100%;
				height:38%;
			}
			
			.phi-layout .phi-top>*:nth-child(1) {
				width:100%;
				height:38%;
			}
			.phi-layout .phi-top>*:nth-child(2) {
				width:100%;
				height:62%;
			}
			
			
			
		</style>
	</head>

	<body>
		<script type="text/javascript">
			console.log('RogueBM[xDLStorageiFrame]: initializing')
			
			//This is for roguerunner injection if you want to do that? Might remove in the future
			function ScriptOBJ(src) { //callback might not work
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src',src);
				script.setAttribute('crossorigin', "anonymous");
				return script
			}
			function inject(){
				document.getElementsByTagName('head')[0].appendChild(ScriptOBJ('/RogueBookmarklets/RogueRunner_inject_src.js'));
			}

			function showError(/*arguments*/){
				var args = Array.prototype.slice.call( arguments );
				args.unshift("RogueBM[xDLStorageiFrame]: ");
				console.error.apply(console, args);
				//statusBar.innerHTML=arguments[0]
			}
			var operations={};
			operations.localstorage=function(){
				//add some security so we don't just load any script from any domain
				var allowedOrigins = [],
				    allowedScriptSources=[
					'https://ktsuttlemyre.github.io'
					],
				    keys=Object.keys(RogueBM.scriptCDNs);

				for(var i=0,key=null;i<keys.length;i++){
					key= RogueBM.stringFormat(RogueBM.scriptCDNs[keys[i]],{path:''})
					console.log('keys',key)
					if(key==null){
						continue
					}
					allowedScriptSources.push(key)
				}

				var post=function(json,domain){
					if(typeof json == 'object'){
						json = JSON.stringify(json)
					}
					if(window.opener && window.opener !== window){
						window.opener.postMessage(json,domain)
					}
					if(parent && parent !== window){
						parent.postMessage(json,domain);
					}
				}

				var _listener = function (e) {
					//if (!allowedOrigins.includes(e.origin)) {
					//    return;
					//}
					//console.log('iframe got message',e)
					var payload = JSON.parse(e.data);
					var parent = window.parent;
					var returnPayload={
						method:payload.method,
						messageID:payload.messageID
					}
					var err;
					try{
						switch(payload.method) {
							case 'convertToInterface':
								inject();
								returnPayload.data=true //TODO make this async so I can tell the interface is installed properly
								break;
							case 'get':
								var data = localStorage.getItem(payload.key);
								returnPayload.data= data;
								break;
							case 'set':
								returnPayload.data=localStorage.setItem(payload.key, JSON.stringify(payload.data));
								//TODO send success/fail
								break;
							case 'getScript': //TODO force allowed origins
								//force it to stay in path?
								//var l = document.createElement("a");
								//l.href = href;
								//l.path
								//var element = document.getElementById('RogueRunner')
								//returnPayload.data=element.innerText || element.textContent;
								//console.log('iframe payload=',payload)

								if(!payload.url){
									err='no url for payload'
									showError(err,payload)
									returnPayload.error=err+':  '+JSON.stringify(payload)

								}
								var fn=function(item){
									return (payload.url.indexOf(item) == 0)
								}
								if(!allowedScriptSources.some(fn)){
									showError('refused to load ',payload.url,'it is not considered a safe domain/path combo as listed here',allowedScriptSources)
									return
								}
								load(payload.url,function(e,data){
									//console.log('load returned something',e,data)
									returnPayload.data=data
									//console.log('iframe got data',data)
									post(returnPayload, '*');
								})

								return
								break;
							case 'remove':
								returnPayload.data=localStorage.removeItem(payload.key);
								break;
							default:
								err='No method on message payload '
								showError(err,payload)
								returnPayload.error=err+':  '+JSON.stringify(payload)
								return

							}

					}catch(err){
						showError('Error:',err)
						returnPayload.error=JSON.stringify(err, Object.getOwnPropertyNames(err))
					}
					post(returnPayload, '*');
					};

				// Support IE8 with attachEvent
				if (window.addEventListener) {
					window.addEventListener('message', _listener, false);
				} else {
					window.attachEvent('onmessage', _listener);
				}
				post({ready:true},'*');
			}
			operations['roguerunner']=function(){inject()}
			function addiFrame(src){
				var iframe = document.createElement('iframe');
				//iframe.style.display = "none";
				iframe.style.height=iframe.style.width='100%';
				iframe.src = 'https://ktsuttlemyre.github.io/RogueBookmarklets/site/'+src;
				document.body.appendChild(iframe);
			}
			function uniq(a) {
			    return a.sort().filter(function(item, pos, ary) {
				return !pos || item != ary[pos - 1];
			    });
			}
			
			function main(){
				var mode=window.location.hash.substring(1)
				if(mode){
					mode=mode.split(',');
				}else{
					operations.roguerunner()
					return
				}
				//if localstorage is there then override all
				if(mode.indexOf('localstorage')>=0){
					operations.localstorage()
					return
				}
				mode=uniq(mode);
				
				for(var i=0,l=mode.length;i<l;i++){
					var op=operations[mode[i]];
					if(op){
						op.call&&op();
					}else{
						addiFrame(mode[i])
					}
				}
				if(mode.indexOf('home')<0){
					operations.roguerunner()
					return
				}
			}
			main()
			console.log('RogueBM[xDLStorageiFrame]: loaded')
		</script>
		<div class="phi-layout">
			<!--<div class='phi-right'><iframe src="https://ktsuttlemyre.github.io/RogueBookmarklets/site/player"></div>-->
			<div class="phi-right">
			    <iframe src="https://ktsuttlemyre.github.io/RogueBookmarklets/site/player"></iframe>
			    <div class="phi-bottom">
			       <iframe src="https://ktsuttlemyre.github.io/RogueBookmarklets/site/delta"></iframe>
				<iframe src="https://ktsuttlemyre.github.io/RogueBookmarklets/site/editor"></iframe>
			    </div>
			</div>
		</div>
	</body>
