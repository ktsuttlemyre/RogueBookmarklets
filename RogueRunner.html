<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="theme-color" content="#222531">
		<script type="text/template" id="RogueRunner"></script>
		<script type="text/javascript" src="/RogueBookmarklets/tests/load.js"></script>
		<script type="text/javascript" src="/RogueBookmarklets/index_stringFormat.js"></script>
	</head>

	<body>
		<button type="button" id="InjectRogueRunner">InjectRogueRunner</button>


		<script type="text/javascript">
			function ScriptOBJ(src) { //callback might not work
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src',src);
				script.setAttribute('crossorigin', "anonymous");
				return script
			}
			document.getElementById('InjectRogueRunner').onclick=function(){ScriptOBJ('/RogueRunner_src.js')};

			function showError(message){
				//statusBar.innerHTML=message
				var args = Array.prototype.slice.call( arguments );
				args.unshift("RogueBM[xDLStorageiFrame]: ");
				console.error.apply(console, args);
			}

			//a comment
			var allowedOrigins = [];
			var allowedScriptSources=[
				'https://ktsuttlemyre.github.io'
			]

			var keys=Object.keys(RogueBM.scriptEndpoints),
				key;
			for(var i=0;i<keys.length;i++){
				key= RogueBM.stringFormat(RogueBM.scriptEndpoints[keys[i]],{path:''})
				console.log('keys',key)
				if(key==null){
					continue
				}
				allowedScriptSources.push(key)
			}

			var post=function(json,domain){
				if(typeof json == 'object'){
					json = JSON.stringify(json)
				}
				if(window.opener && window.opener !== window){
					window.opener.postMessage(json,domain)
				}
				if(parent && parent !== window){
					parent.postMessage(json,domain);
				}
			}

			var _listener = function (e) {
				//if (!allowedOrigins.includes(e.origin)) {
				//    return;
				//}
				//console.log('iframe got message',e)
				var payload = JSON.parse(e.data);
				var parent = window.parent;
				var returnPayload={
					method:payload.method,
					messageID:payload.messageID
				}
				var err;
				try{
					switch(payload.method) {
						case 'get':
							var data = localStorage.getItem(payload.key);
							returnPayload.data= data;
							break;
						case 'set':
							returnPayload.data=localStorage.setItem(payload.key, JSON.stringify(payload.data));
							//TODO send success/fail
							break;
						case 'getScript': //TODO force allowed origins
							//force it to stay in path?
							//var l = document.createElement("a");
							//l.href = href;
							//l.path
							//var element = document.getElementById('RogueRunner')
							//returnPayload.data=element.innerText || element.textContent;
							//console.log('iframe payload=',payload)
							debugger
							if(!payload.url){
								err='no url for payload'
								showError(err,payload)
								returnPayload.error=err+':  '+JSON.stringify(payload)
								console.log()

							}
							var fn=function(item){
								return (payload.url.indexOf(item) == 0)
							}
							if(!allowedScriptSources.some(fn)){
								showError('refused to load ',payload.url,'it is not considered a safe domain/path combo as listed here',allowedScriptSources)
								return
							}
							load(payload.url,function(e,data){
								//console.log('load returned something',e,data)
								returnPayload.data=data
								//console.log('iframe got data',data)
								post(returnPayload, '*');
							})
						
							return
							break;
						case 'remove':
							returnPayload.data=localStorage.removeItem(payload.key);
							break;
						default:
							err='No method on message payload '
							showError(err,payload)
							returnPayload.error=err+':  '+JSON.stringify(payload)
							return
						
						}

				}catch(err){
					showError('Error:',err)
					returnPayload.error=JSON.stringify(err, Object.getOwnPropertyNames(err))
				}
				post(returnPayload, '*');
				};

			// Support IE8 with attachEvent
			if (window.addEventListener) {
				window.addEventListener('message', _listener, false);
			} else {
				window.attachEvent('onmessage', _listener);
			}
			post({ready:true},'*');
		</script>
	</body>
</html>